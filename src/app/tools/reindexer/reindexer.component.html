<div class="wrapper mat-elevation-z8">
    <div class="table-container">
        <div class="loading-shade" *ngIf="isLoadingResults ">
            <mat-spinner *ngIf="isLoadingResults"></mat-spinner>
          </div>
      <table mat-table [dataSource]="tableData" matSort multiTemplateDataRows
      matSort matSortActive="id" matSortDisableClear matSortDirection="asc"
      >
        <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selectedRows.hasValue() && isAllSelected()"
                [indeterminate]="selectedRows.hasValue() && !isAllSelected()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row">
              <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selectedRows.toggle(row) : null"
                [checked]="selectedRows.isSelected(row)">
              </mat-checkbox>
            </td>
          </ng-container>
  
          <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Id</th>
              <td mat-cell *matCellDef="let element"> {{element.id}}</td>
            </ng-container>
    
          <ng-container matColumnDef="author__username">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Author</th>
            <td mat-cell *matCellDef="let element"> {{element.author_username}}</td>
          </ng-container>
          
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Description</th>
          <td mat-cell *matCellDef="let element"> {{element.description}}</td>
        </ng-container>

        <ng-container matColumnDef="task__time_started">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Time started</th>
          <td mat-cell *matCellDef="let element"> {{element.task.time_started | date:['MMM d, h:mm:ss a']}}</td>
        </ng-container>
        <ng-container matColumnDef="task__time_completed">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Time completed</th>
          <td mat-cell *matCellDef="let element">
            <span *ngIf="element.task.time_completed">{{element.task.time_completed | date:['MMM d, h:mm:ss a']}}</span>
            <span *ngIf="!element.task.time_completed">Null</span>
          </td>
        </ng-container>
        <ng-container matColumnDef="fields">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Fields</th>
          <td mat-cell *matCellDef="let element"> {{element.fields}}</td>
        </ng-container>
        <ng-container matColumnDef="random_size">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Random size</th>
          <td mat-cell *matCellDef="let element"> {{element.random_size}}</td>
        </ng-container>
        <ng-container matColumnDef="show_query">
          <th mat-header-cell *matHeaderCellDef> Query </th>
          <td mat-cell *matCellDef="let element">
            <span class="action-text mat-body-strong pointer" (click)="openQueryDialog(element.query)">Show Query</span>
          </td>
        </ng-container>
        <ng-container matColumnDef="new_index">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> New index</th>
          <td mat-cell *matCellDef="let element"> {{element.new_index}}</td>
        </ng-container>
        <ng-container matColumnDef="task__status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Task</th>
          <td mat-cell *matCellDef="let element">
            <mat-progress-bar
              mode="determinate"
              [value]="element.task.progress">
            </mat-progress-bar>
            <mat-hint>{{element.task.status}}  {{element.task.step}}</mat-hint>
          </td>
        </ng-container>
  
  
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
            <div class="element-detail"
                 [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                 <div class="flex-row element-detail-plot-fields">
                    <div *ngIf="element.plot"><img class="element-plot" [src]="element.plot"></div>
                      <div class="flex-col m-l-r-5">
                        <table class="simple-table">
                              <tr>
                              <th class="mat-body-strong">Task id</th>
                                <td>{{element.task.id}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Status</th>
                              <td>{{element.task.status}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Progress</th>
                              <td>{{element.task.progress}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Step</th>
                              <td>{{element.task.step}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Errors</th>
                              <td>{{element.task.errors}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Time Started</th>
                              <td>{{element.task.time_started}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Last Update</th>
                              <td>{{element.task.last_update}}</td>
                              </tr>
                              <tr>
                              <th class="mat-body-strong">Time Completed</th>
                              <td>{{element.task.time_completed}}</td>
                              </tr>
                          </table>
                      </div>
                      <div class="flex-col m-l-r-5">
                        <table class="simple-table">
                              <tr>
                              <th class="mat-body-strong">Fields Types</th>
                              <td>{{element.fields_type_parsed}}</td>
                              </tr>
                          </table>
                      </div>
                  </div>
            </div>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="Modify">
            <th mat-header-cell class="center-header-cell" *matHeaderCellDef>Edit</th>
            <td mat-cell *matCellDef="let element; let i = dataIndex" (click)="$event.stopPropagation();">
    
              <button mat-icon-button color="primary" [matMenuTriggerFor]="editMenu">
                <mat-icon aria-label="Edit Options">more_vert</mat-icon>
              </button>
              <mat-menu #editMenu="matMenu">
                <button mat-menu-item (click)="onDelete(element, i)">
                    Delete
                </button>
              </mat-menu>
    
            </td>
          </ng-container>
  
        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let element; columns: displayedColumns;"
            class="element-row"
            [class.expanded-row]="expandedElement === element"
            (click)="expandedElement = expandedElement === element ? null : element"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
  
      </table>
  
    </div>
  
    <div class="table-paginator-row">
      <button class="new-resource-btn" mat-button color="primary" (click)="openCreateDialog()"><mat-icon>add</mat-icon> CREATE </button>
      <button class="new-resource-btn" mat-icon-button color="warn" (click)="onDeleteAllSelected()" matTooltip="Delete selected" [disabled]="selectedRows.selected.length < 1"><mat-icon>delete</mat-icon></button>
      <mat-form-field class="m-l-15">
          <mat-icon matSuffix>search</mat-icon>
          <input matInput (keyup)="applyFilter($event.target.value, 'description')" placeholder="Filter description">
      </mat-form-field>
      <mat-form-field class="m-l-15">
          <mat-icon matSuffix>search</mat-icon>
          <input matInput (keyup)="applyFilter($event.target.value, 'task_status')" placeholder="Filter task status">
      </mat-form-field>
    </div>
  
    <mat-paginator [pageSizeOptions]="[15, 50, 100]" showFirstLastButtons [length]="resultsLength">
    </mat-paginator>
  
  </div>
