<div class="wrapper" fxFlex fxLayout="column">

  <div class="aggregation-form" fxFlex fxLayout="column" *ngFor="let aggregation of aggregationList; let i = index;">

    <div fxFlex fxLayoutAlign="end" *ngIf="!checkIfMainAggregation(i)">
      <button mat-icon-button aria-label="Close" (click)="removeAggregation(i)" class="mat-icon-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <mat-form-field appearance="outline" class="max-width">
      <mat-label>Select Fields</mat-label>
      <mat-select panelClass="select-panel-reveal-input" [disableOptionCentering]="true"
                  [formControl]="aggregation.formControl">
        <mat-optgroup *ngFor="let group of projectFields" [label]="group.index">
          <mat-option *ngFor="let fields of group.fields" [value]="fields">
            {{fields.path}}
          </mat-option>
        </mat-optgroup>
      </mat-select>
    </mat-form-field>

    <ng-container *ngIf="fieldTypeTextOrFact(aggregation.formControl.value)">
      <app-text-aggregation [id]=i
                            [notSubAgg]="checkIfMainAggregation(i)"
                            [fieldsFormControl]="aggregation.formControl"
                            [aggregationObj]="aggregation">
      </app-text-aggregation>
    </ng-container>
    <ng-container *ngIf="fieldTypeDate(aggregation.formControl.value)">
      <app-date-aggregation [id]=i
                            [notSubAgg]="checkIfMainAggregation(i)"
                            [fieldsFormControl]="aggregation.formControl"
                            [aggregationObj]="aggregation">
      </app-date-aggregation>
    </ng-container>
    <mat-divider></mat-divider>
  </div>
  <button class="flex-item-center" mat-icon-button aria-label="add sub aggregation" (click)="addNewAggregation()"
          [disabled]="!(aggregationList.length > 0 && aggregationList[0].formControl.value)">
    <mat-icon>add</mat-icon>
  </button>

  <mat-checkbox class="exclude-search-checkbox" [(ngModel)]="searchQueryExcluded"
                labelPosition="before">Exclude current
    search:
  </mat-checkbox>

  <div class="max-width">
    <button class="max-width" mat-stroked-button (click)="aggregate()"
            [disabled]="!(aggregationList.length > 0 && aggregationList[0].formControl.value)">
      Aggregate
    </button>
  </div>
</div>
